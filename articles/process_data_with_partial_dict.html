<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="dataRC">
<title>Process data with a partial dictionary • dataRC</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Process data with a partial dictionary">
<meta property="og:description" content="dataRC">
<meta property="og:image" content="https://jdrengifoc.github.io/dataRC/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">dataRC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/process_data_with_partial_dict.html">Process data with a partial dictionary</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Process data with a partial dictionary</h1>
            
      
      
      <div class="d-none name"><code>process_data_with_partial_dict.Rmd</code></div>
    </div>

    
    
<p>First and foremost, for this vignette we need to install and load the
following libraries.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jdrengifoc.github.io/dataRC/">dataRC</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span></code></pre></div>
<p>Lets consider a sample of the dataset of Nonfetal Vital Statistics
(NVS), a public Colombian dataset that records all the deaths between
1998 and 2022 of people born alive. This data is published by the
Colombian National Administrative Department of Statistics (DANE by its
spanish acronym) in its <a href="https://www.dane.gov.co/index.php/estadisticas-por-tema/salud/nacimientos-y-defunciones" class="external-link">website</a>,
such that each year can be downloaded in traditional formats (sav, txt,
csv, dta). The number of variables per year ranges from 48 to 69, while
the number of rows can reach up to 363,089.</p>
<p>For this vignette I sampled 100 rows for each year (each row records
a death). Of course such small sample do not demand significant
computational resources. However, in its original form, this dataset
requires more than 2GB of storage, demand that is reduced to 123.8 MB by
converting the files to parquet format. This efficiency gain can be
easily replicated with the function <code><a href="../reference/convert_files.html">convert_files()</a></code>, as is
shown in the next chunk of code.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Folder where is stored the data.</span></span>
<span><span class="va">folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, package <span class="op">=</span> <span class="st">'dataRC'</span><span class="op">)</span></span>
<span><span class="co"># The files to convert are all the ones that began with "nofetal", have a four </span></span>
<span><span class="co"># digit year and ends with ".xlsx".</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">folder</span>, pattern <span class="op">=</span> <span class="st">'^nofetal\\d{4}\\.csv$'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/convert_files.html">convert_files</a></span><span class="op">(</span></span>
<span>  <span class="va">folder</span>,</span>
<span>  <span class="va">files</span>, </span>
<span>  <span class="co"># I want to convert the files to parquet.</span></span>
<span>  new_extension <span class="op">=</span> <span class="st">'parquet'</span>, </span>
<span>  <span class="co"># I want to store the parquet data in the same folder.</span></span>
<span>  new_folder <span class="op">=</span> <span class="va">folder</span>,</span>
<span>  <span class="co"># Do not display progress messages.</span></span>
<span>  verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p>As this data has been developed since the previous century, is no
surprise that there have been many changes on how the data is stored.
For instance, the table below shows that the number of variables per
year has changes drastically across the years, and even for the years
with same number of variables, the number of columns per datatype
differ.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The new parquet files.</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">folder</span>, pattern <span class="op">=</span> <span class="st">'^nofetal\\d{4}\\.parquet$'</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Get the number of columns per year.</span></span>
<span><span class="va">cols_per_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder</span>, <span class="va">file</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">ncol</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unlist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unname</span></span>
<span><span class="co"># Get the number of columns per year and column classes.</span></span>
<span><span class="va">classes_per_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html" class="external-link">read_parquet</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">table</span><span class="op">)</span> </span>
<span><span class="va">character_per_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">classes_per_year</span>, </span>
<span>                             <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>                               <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="st">'character'</span><span class="op">]</span></span>
<span>                               <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">x</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>                               <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>                               <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unlist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unname</span></span>
<span><span class="va">integer_per_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">classes_per_year</span>, </span>
<span>                           <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>                             <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="st">'integer'</span><span class="op">]</span></span>
<span>                             <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">x</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>                             <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>                             <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unlist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unname</span></span>
<span><span class="va">logical_per_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">classes_per_year</span>, </span>
<span>                           <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>                             <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="st">'logical'</span><span class="op">]</span></span>
<span>                             <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">x</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>                             <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>                             <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unlist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unname</span></span>
<span><span class="va">numeric_per_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">classes_per_year</span>, </span>
<span>                           <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>                             <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="st">'numeric'</span><span class="op">]</span></span>
<span>                             <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">x</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>                             <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>                             <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unlist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unname</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1998</span><span class="op">:</span><span class="fl">2022</span>, n_vars<span class="op">=</span> <span class="va">cols_per_year</span>, </span>
<span>           character_vars <span class="op">=</span> <span class="va">character_per_year</span>,</span>
<span>           integer_vars <span class="op">=</span> <span class="va">integer_per_year</span>,</span>
<span>           logical_vars <span class="op">=</span> <span class="va">logical_per_year</span>,</span>
<span>           numeric_vars <span class="op">=</span> <span class="va">numeric_per_year</span></span>
<span>           <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">print</span></span>
<span><span class="co">#&gt;    year n_vars character_vars integer_vars logical_vars numeric_vars</span></span>
<span><span class="co">#&gt; 1  1998     48              2           36           10            0</span></span>
<span><span class="co">#&gt; 2  1999     48              7           39            2            0</span></span>
<span><span class="co">#&gt; 3  2000     48              2           36           10            0</span></span>
<span><span class="co">#&gt; 4  2001     48              8           39            0            1</span></span>
<span><span class="co">#&gt; 5  2002     48              7           40            1            0</span></span>
<span><span class="co">#&gt; 6  2003     48              7           39            1            1</span></span>
<span><span class="co">#&gt; 7  2004     48              8           39            0            1</span></span>
<span><span class="co">#&gt; 8  2005     48              8           39            0            1</span></span>
<span><span class="co">#&gt; 9  2006     48              7           39            1            1</span></span>
<span><span class="co">#&gt; 10 2007     48              7           40            1            0</span></span>
<span><span class="co">#&gt; 11 2008     68              7           54            7            0</span></span>
<span><span class="co">#&gt; 12 2009     68             12           54            2            0</span></span>
<span><span class="co">#&gt; 13 2010     68             10           53            5            0</span></span>
<span><span class="co">#&gt; 14 2011     68             11           54            3            0</span></span>
<span><span class="co">#&gt; 15 2012     69             13           51            4            1</span></span>
<span><span class="co">#&gt; 16 2013     69             15           50            3            1</span></span>
<span><span class="co">#&gt; 17 2014     68             11           54            3            0</span></span>
<span><span class="co">#&gt; 18 2015     68             13           50            5            0</span></span>
<span><span class="co">#&gt; 19 2016     68             11           51            6            0</span></span>
<span><span class="co">#&gt; 20 2017     68             13           39           16            0</span></span>
<span><span class="co">#&gt; 21 2018     68             12           48            8            0</span></span>
<span><span class="co">#&gt; 22 2019     56              3           50            3            0</span></span>
<span><span class="co">#&gt; 23 2020     55              3           46            6            0</span></span>
<span><span class="co">#&gt; 24 2021     56              4           50            2            0</span></span>
<span><span class="co">#&gt; 25 2022     57              4           40           13            0</span></span></code></pre></div>
<p>Besides, the number of unique variable names for all years is 145,
despite there whole majority of columns is common across years.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder</span>, <span class="va">file</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">names</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unlist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unname</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unique</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">length</span></span>
<span><span class="co">#&gt; [1] 145</span></span></code></pre></div>
<p>These kind of problematic scenarios are suitable for the functions
<code><a href="../reference/create_partial_dictionary.html">create_partial_dictionary()</a></code> and
<code><a href="../reference/sort_partial_dictionary.html">sort_partial_dictionary()</a></code>, which create a “partial”
dictionary that ease the process of unify the data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dict_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder</span>, <span class="st">'dict.xlsx'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">dict_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/create_partial_dictionary.html">create_partial_dictionary</a></span><span class="op">(</span><span class="va">folder</span>, <span class="va">files</span>, <span class="va">dict_path</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sort_partial_dictionary.html">sort_partial_dictionary</a></span><span class="op">(</span><span class="va">dict_path</span>, overwrite <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Save sorted dictionary in /home/runner/.cache/R/renv/library/dataRC-f4d37bc5/R-4.4/x86_64-pc-linux-gnu/dataRC/extdata/dict.xlsx.</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dict</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_excel</a></span><span class="op">(</span><span class="va">dict_path</span>, sheet <span class="op">=</span> <span class="st">'colname'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">print</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 75 × 30</span></span></span>
<span><span class="co">#&gt;    uniname   uniclass  class_mode unique_classes   coverage nofetal1998.parquet</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> A_DEFUN   integer   integer    integer               100 a_defun            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> ANO       integer   integer    integer               100 ano                </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> AREA_RES  integer   integer    integer               100 area_res           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> ASIS_MED  integer   integer    integer               100 asis_med           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> C_BAS1    character character  character             100 c_bas1             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> C_MUERTE  <span style="color: #BB0000;">NA</span>        integer    integer; logical      100 c_muerte           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> CAU_HOMOL integer   integer    integer               100 cau_homol          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> COD_DPTO  integer   integer    integer               100 cod_dpto           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> COD_MUNIC integer   integer    integer               100 cod_munic          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> CODMUNOC  <span style="color: #BB0000;">NA</span>        integer    logical; integer      100 codmunoc           </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 65 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 24 more variables: nofetal1999.parquet &lt;chr&gt;, nofetal2000.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2001.parquet &lt;chr&gt;, nofetal2002.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2003.parquet &lt;chr&gt;, nofetal2004.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2005.parquet &lt;chr&gt;, nofetal2006.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2007.parquet &lt;chr&gt;, nofetal2008.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2009.parquet &lt;chr&gt;, nofetal2010.parquet &lt;chr&gt;, …</span></span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">dict_path</span><span class="op">)</span></span></code></pre></div>
<p>This could be done easily with the previous chunk of code, which
writes a xlsx file with two sheets: <code>colnames</code> and
<code>colclass</code>. Both sheets have one column per file, which in
the former case have all the variable names of the file and in the
latter have the datatype (class) per variable. Besides, the first column
<code>uniname</code> is common for both sheets. Based on the variable
names of all files, this column propose a name to group common variables
across files. The common variables are determined if the names across
files are equal ignoring upper and lower case. Of course this is a naive
approach, so the user must review if the <code>uniname</code>s could be
reduced more. For instance, lets imagine that we have three files that
have a column with the month. In the first file this column is named as
<code>month</code>, in the second file <code>MONTH</code> and in the
latter <code>mes</code>. The associated partial dictionary will propose
two different <code>uniname</code>s: <code>MONTH</code> and
<code>MES</code>, however the user manually should combine this
<code>uniname</code>s in one.</p>
<p>By its part, based on the <code>colclass</code> sheet, the
<code>colnames</code> sheet has three columns related to the class types
of the variables per <code>uniname</code>. The first one is the
<code>uniclass</code>, which should be manually filled by the user with
the desired class for all the variables associated to each
<code>uniname</code>. To fill this is usefull to look the columns
<code>class_mode</code> and <code>unique_classes</code>. The former has
the mode of the class (or modes in case of ties) and the latter have the
unique classes across files. As shown latter, the <code>uniname</code>
and <code>uniclass</code> columns will ease the processing of the
data.</p>
<p>For our sample of NVS we have the following partial dictionary. The
dictionary is sorted by the <code>uniname</code> in descended order for
number of matches, at the presence of ties, it is used the natural sort
order. For instance, from the first row (<code>uniname</code> ==
<code>A_DEFUN</code>) until the 37th (<code>uniname</code> ==
<code>TIPO_EMB</code>), all the <code>uniname</code>s have a variable on
each file so no manual work must be done. However,
<code>IDADMISALUD</code> (2008-2011 and 2014-2022) and
<code>IDADMISALU</code> (2012-2013) could be joined in one
<code>uniname</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">uniname</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'IDADMISALUD'</span>, <span class="st">'IDADMISALU'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 30</span></span></span>
<span><span class="co">#&gt;   uniname     uniclass class_mode unique_classes coverage nofetal1998.parquet</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> IDADMISALUD integer  integer    integer              52 <span style="color: #BB0000;">NA</span>                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> IDADMISALU  integer  integer    integer               8 <span style="color: #BB0000;">NA</span>                 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 24 more variables: nofetal1999.parquet &lt;chr&gt;, nofetal2000.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2001.parquet &lt;chr&gt;, nofetal2002.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2003.parquet &lt;chr&gt;, nofetal2004.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2005.parquet &lt;chr&gt;, nofetal2006.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2007.parquet &lt;chr&gt;, nofetal2008.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2009.parquet &lt;chr&gt;, nofetal2010.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2011.parquet &lt;chr&gt;, nofetal2012.parquet &lt;chr&gt;, …</span></span></span></code></pre></div>
<p>The unification could be done in three steps. First, determine in
which <code>uniname</code> do you want to keep, in my case I prefer
<code>IDADMISALUD</code> since have more elements and
<code>IDADMISALU</code> has a spanish typo. Second, update the rows of
the selected <code>uniname</code> with the rows of the discarded
<code>uniname</code>. Finally, delete the discarded
<code>uniname</code>. This could be easily done directly in Excel,
however this code also satisfy our needs.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Before unification:'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Before unification:"</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">uniname</span> <span class="op">==</span> <span class="st">'IDADMISALUD'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">nofetal2012.parquet</span>, <span class="va">nofetal2013.parquet</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   nofetal2012.parquet nofetal2013.parquet</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="color: #BB0000;">NA</span>                  <span style="color: #BB0000;">NA</span></span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dict</span> <span class="op">&lt;-</span> <span class="va">dict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># Update the rows of `IDADMISALUD`.</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    nofetal2012.parquet <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">uniname</span> <span class="op">==</span> <span class="st">'IDADMISALUD'</span>, <span class="st">'IDADMISALU'</span>, <span class="va">nofetal2012.parquet</span><span class="op">)</span>,</span>
<span>    nofetal2013.parquet <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">uniname</span> <span class="op">==</span> <span class="st">'IDADMISALUD'</span>, <span class="st">'IDADMISALU'</span>, <span class="va">nofetal2013.parquet</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># Delete `IDADMISALU`.</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">uniname</span> <span class="op">!=</span> <span class="st">'IDADMISALU'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'After unification:'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "After unification:"</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">uniname</span> <span class="op">==</span> <span class="st">'IDADMISALUD'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">nofetal2012.parquet</span>, <span class="va">nofetal2013.parquet</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   nofetal2012.parquet nofetal2013.parquet</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> IDADMISALU          IDADMISALU</span></span></code></pre></div>
<p>The manual review of the <code>uniname</code>s and the
<code>uniclass</code>es could be elaborated gradually as we need to use
a variable. For instance, lets supposed that we are interested in answer
whether women or men have a higher number of deaths in Colombia. For
this we just need the year and sex variable. By looking our dictionary
we notice that the <code>uninames</code> <code>ANO</code> and
<code>SEXO</code> have a integer related variable in all files (despite
the names are case sensitive different).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">uniname</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ANO'</span>, <span class="st">'SEXO'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 30</span></span></span>
<span><span class="co">#&gt;   uniname uniclass class_mode unique_classes coverage nofetal1998.parquet</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ANO     integer  integer    integer             100 ano                </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> SEXO    integer  integer    integer             100 sexo               </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 24 more variables: nofetal1999.parquet &lt;chr&gt;, nofetal2000.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2001.parquet &lt;chr&gt;, nofetal2002.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2003.parquet &lt;chr&gt;, nofetal2004.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2005.parquet &lt;chr&gt;, nofetal2006.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2007.parquet &lt;chr&gt;, nofetal2008.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2009.parquet &lt;chr&gt;, nofetal2010.parquet &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nofetal2011.parquet &lt;chr&gt;, nofetal2012.parquet &lt;chr&gt;, …</span></span></span></code></pre></div>
<p>To achieve our objective we could employ the following code.
Initially this could seem a bit overwhelming, however, the intuition is
simple. You began by determining which columns you need in
<code>SELECTED_COLUMNS &lt;- c('ANO', 'SEXO')</code>. Then for each
file, keep only the desired columns, rename it to their
<code>uniname</code>, compute the number of deaths per sex and save the
results in <code>df</code>. Finally, calculate the proportion of deaths
per sex on each year. Notice that the vast majority of the code is for
go for each file and unify the names, so you just need to modify three
things:</p>
<ul>
<li>Which columns you need in
<code>SELECTED_COLUMNS &lt;- c('ANO', 'SEXO')</code>.</li>
<li>The processing per file.</li>
<li>The processing of the whole data.</li>
</ul>
<p>In the following chunk, this just represents four lines, the rest is
the same for any scenario. In other words, this is a template!</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># BEGAN MODIFY:  Which columns you need?</span></span>
<span><span class="va">SELECTED_COLUMNS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ANO'</span>, <span class="st">'SEXO'</span><span class="op">)</span></span>
<span><span class="co"># END MODIFY. </span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">file</span> <span class="kw">in</span> <span class="va">files</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Open file with lazy evaluation for speed (you could also use</span></span>
<span>  <span class="co"># `read_parquet()`).</span></span>
<span>  <span class="va">df0</span> <span class="op">&lt;-</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder</span>, <span class="va">file</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/unify_colnames.html">unify_colnames</a></span><span class="op">(</span><span class="va">dict</span>, <span class="va">file</span>, <span class="va">SELECTED_COLUMNS</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="../reference/unify_classes.html">unify_classes</a></span><span class="op">(</span><span class="va">dict</span>, <span class="va">file</span>, <span class="va">SELECTED_COLUMNS</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="../reference/relocate_columns.html">relocate_columns</a></span><span class="op">(</span><span class="va">SELECTED_COLUMNS</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="co"># BEGAN MODIFY: Process your data as required  with the `uniname`s.</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ANO</span>, <span class="va">SEXO</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n_ <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="co"># END MODIFY. </span></span>
<span>    </span>
<span>    <span class="co"># End lazy evaluation. If you use `read_parquet() this is unnecesary.</span></span>
<span>    <span class="va">collect</span></span>
<span>  </span>
<span>  <span class="co"># Save the iteration results.</span></span>
<span>  <span class="co"># NOTE: # If all columns are going to have the same columns is recommended to </span></span>
<span>  <span class="co"># use `rbind()`.</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># MODIFY: Process your data as required.</span></span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ANO</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prop_ <span class="op">=</span> <span class="va">n_</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 50 × 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   ANO [25]</span></span></span>
<span><span class="co">#&gt;      ANO  SEXO    n_ prop_</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  <span style="text-decoration: underline;">1</span>998     2    43  0.43</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  <span style="text-decoration: underline;">1</span>998     1    57  0.57</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  <span style="text-decoration: underline;">1</span>999     1    78  0.78</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">1</span>999     2    22  0.22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  <span style="text-decoration: underline;">2</span>000     2    38  0.38</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">2</span>000     1    62  0.62</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  <span style="text-decoration: underline;">2</span>001     1    78  0.78</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  <span style="text-decoration: underline;">2</span>001     2    22  0.22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  <span style="text-decoration: underline;">2</span>002     2    40  0.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  <span style="text-decoration: underline;">2</span>002     1    60  0.6 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 40 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># END MODIFY. </span></span></code></pre></div>
<p>But what if the per <code>uniname</code> the variable have different
classes per file. Well, we need a small extra step. To see this lets
artificially change the <code>ANO</code> integer class to a character
for the 2022 file.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path_file_2022</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder</span>, <span class="va">files</span><span class="op">[</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">files</span>, <span class="st">'2022'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="va">path_file_2022</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ANO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ANO</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html" class="external-link">write_parquet</a></span><span class="op">(</span><span class="va">path_file_2022</span><span class="op">)</span></span></code></pre></div>
<p>Now, this is not a major problem, if we run the previous code we will
obtain the same results, with the only difference that the
<code>ANO</code> will be now a character. However, in many scenarios
this could be problematic and inefficient. To solve this we need to make
two changes to our current methodology. First, we manually must fill the
<code>uniclass</code> column of our dictionary for the problematic
variable (in this case <code>ANO</code> must be an integer). Again, this
could be easily done in Excel but for our purposes we will use code.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dict</span> <span class="op">&lt;-</span> <span class="va">dict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>uniclass <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">uniname</span> <span class="op">==</span> <span class="st">'ANO'</span>, <span class="st">'integer'</span>, <span class="va">uniclass</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then, we will add a few lines to our template so that for each file,
the selected columns are force to have the data type of
<code>uniclass</code>. The following code support: “integer”, “logical”,
“numeric”, “character” and “date”. This makes our template larger, but
does not add to us more work.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># BEGAN MODIFY:  Which columns you need?</span></span>
<span><span class="va">SELECTED_COLUMNS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ANO'</span>, <span class="st">'SEXO'</span><span class="op">)</span></span>
<span><span class="co"># END MODIFY. </span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">file</span> <span class="kw">in</span> <span class="va">files</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Open file with lazy evaluation for speed (you could also use</span></span>
<span>  <span class="co"># `read_parquet()`).</span></span>
<span>  <span class="va">df0</span> <span class="op">&lt;-</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder</span>, <span class="va">file</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="co"># Select `SELECTED_COLUMNS` and rename it with the `uniname`s.</span></span>
<span>    <span class="fu"><a href="../reference/unify_colnames.html">unify_colnames</a></span><span class="op">(</span><span class="va">dict</span>, <span class="va">file</span>, <span class="va">SELECTED_COLUMNS</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="co"># Force the class. NOTE: Lazy evaluation is picky, so if you have</span></span>
<span>    <span class="co"># problematic values (e.g. "" to numeric), you will need to filter those</span></span>
<span>    <span class="co"># observations or collect.</span></span>
<span>    <span class="fu"><a href="../reference/unify_classes.html">unify_classes</a></span><span class="op">(</span><span class="va">dict</span>, <span class="va">file</span>, <span class="va">SELECTED_COLUMNS</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="co"># Preserve order.</span></span>
<span>    <span class="fu"><a href="../reference/relocate_columns.html">relocate_columns</a></span><span class="op">(</span><span class="va">SELECTED_COLUMNS</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># BEGAN MODIFY: Process your data as required  with the `uniname`s. NOTE:</span></span>
<span>    <span class="co"># Again lazy evaluation is picky and is still on develop to support more</span></span>
<span>    <span class="co"># functions. Therefore, some features cannot be done in it, such as</span></span>
<span>    <span class="co"># `dplyr::slice` or window functions. If this is the case you can collect</span></span>
<span>    <span class="co"># and do the processing normally, however this could consume a lot of time,</span></span>
<span>    <span class="co"># then you could  be creative and look for another way to achieve the</span></span>
<span>    <span class="co"># objective. Nevertheless, one option is to employ the function</span></span>
<span>    <span class="co"># `arrow::to_duckdb()`, which allow you to use more function without</span></span>
<span>    <span class="co"># increasing to much the time consumption.</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ANO</span>, <span class="va">SEXO</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n_ <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="co"># END MODIFY. </span></span>
<span>  </span>
<span>    <span class="co"># End lazy evaluation. If you use `read_parquet() this is unnecesary.</span></span>
<span>    <span class="va">collect</span></span>
<span>  </span>
<span>  <span class="co"># Save the iteration results.</span></span>
<span>  <span class="co"># NOTE: # If all columns are going to have the same columns is recommended to </span></span>
<span>  <span class="co"># use `rbind()`.</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># MODIFY: Process your data as required.</span></span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ANO</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prop_ <span class="op">=</span> <span class="va">n_</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 50 × 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   ANO [25]</span></span></span>
<span><span class="co">#&gt;      ANO  SEXO    n_ prop_</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  <span style="text-decoration: underline;">1</span>998     2    43  0.43</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  <span style="text-decoration: underline;">1</span>998     1    57  0.57</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  <span style="text-decoration: underline;">1</span>999     1    78  0.78</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">1</span>999     2    22  0.22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  <span style="text-decoration: underline;">2</span>000     2    38  0.38</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">2</span>000     1    62  0.62</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  <span style="text-decoration: underline;">2</span>001     1    78  0.78</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  <span style="text-decoration: underline;">2</span>001     2    22  0.22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  <span style="text-decoration: underline;">2</span>002     2    40  0.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  <span style="text-decoration: underline;">2</span>002     1    60  0.6 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 40 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># END MODIFY. </span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Juan David Rengifo-Castro.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
